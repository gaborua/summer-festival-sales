<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Summer Festival 2026</title>
        <style>
        :root{
            --pink:#E91E63; --magenta:#C2185B; --purple:#4A148C; --bg:#0e0017; --ink:#222; --muted:#6b6b6b;
            --row:#fff; --row-alt:#fdf1f6; --border:#f2e7f3; --card:rgba(255,255,255,.98);
            --success:#2e7d32; --link:#c2185b;
        }
        *{margin:0;padding:0;box-sizing:border-box}
            body{font-family:'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif; font-size:17px; line-height:1.45; color:var(--ink);
            background: radial-gradient(1200px 800px at 20% 10%, #ff6ea133 0%, rgba(255,110,161,0) 70%), linear-gradient(135deg, var(--pink) 0%, #880E4F 50%, var(--purple) 100%);
            min-height:100vh; padding:32px}
            .container{max-width:1240px;margin:0 auto}
        header{text-align:center;color:white;margin-bottom:28px}
        .logo{font-size:3.4rem;font-weight:900;letter-spacing:3px;text-shadow:0 8px 28px rgba(0,0,0,.35);margin-bottom:6px}
        .subtitle{font-size:1.05rem;font-weight:700;opacity:.95}

            .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;margin:20px 0}
            .stat-card{background:#ffffff;padding:26px;border-radius:18px;box-shadow:0 18px 48px rgba(0,0,0,.28);text-align:center;transition:transform .25s; border:1px solid #f2e7f3}
        .stat-card:hover{transform:translateY(-4px)}
            .stat-card h3{font-size:2.8rem;background:linear-gradient(135deg,var(--pink) 0%, var(--magenta) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px;font-weight:900}
            .stat-card p{color:#555;font-size:1rem;font-weight:800;text-transform:uppercase;letter-spacing:1.1px}

        .chips{display:flex;flex-wrap:wrap;gap:10px;margin:10px 2px 22px}
        .chip{background:var(--card);color:var(--purple);border:1px solid #f3e5f5;padding:8px 12px;border-radius:999px;font-size:.85rem;font-weight:800;box-shadow:0 6px 16px rgba(0,0,0,.12)}

        .table-card{background:#fff;padding:24px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.30)}
        .table-header{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;align-items:center;margin-bottom:12px}
        .table-header h2{color:var(--pink);font-size:1.5rem;font-weight:900}

        .controls{display:flex;gap:10px;align-items:center}
        select,input[type="search"]{padding:10px 12px;border:2px solid #f0f0f0;border-radius:10px;background:#fafafa;font-size:14px}
        .btn{padding:12px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:900;color:white;background:linear-gradient(135deg,var(--pink) 0%, var(--magenta) 100%);box-shadow:0 6px 16px rgba(233,30,99,.35);transition:transform .2s, box-shadow .2s}
        .btn:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(233,30,99,.45)}

        .table-wrap{overflow:auto;max-height:66vh;border-radius:12px}
        table{width:100%;border-collapse:separate;border-spacing:0;background:#fff}
        col.id{width:70px} col.city{width:140px} col.tickets{width:110px} col.receipt{width:190px} col.date{width:190px}
        thead th{position:sticky;top:0;z-index:1;background:linear-gradient(135deg,var(--pink) 0%, var(--magenta) 100%);color:white}
        th,td{padding:14px 12px;text-align:left;border-bottom:1px solid var(--border);font-size:1rem}
        tbody tr:hover{background:var(--row-alt)}
        td.num{text-align:right;font-weight:900;font-variant-numeric:tabular-nums}
        .link{color:var(--link);font-weight:800;text-decoration:none}
        .link:hover{text-decoration:underline}

        .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:.80rem;font-weight:900;letter-spacing:.2px}
        .pill-count{background:#f8eaf6;color:#b0004e;border:1px solid #f3d0e3}
        .pill-city{color:#fff}
        .city-general{background:#b0bec5}
        .city-tarija{background:linear-gradient(135deg,#ff9800,#ff6f00)}
        .city-santacruz{background:linear-gradient(135deg,#43a047,#2e7d32)}
        .city-cochabamba{background:linear-gradient(135deg,#00897b,#00695c)}
        .city-lapaz{background:linear-gradient(135deg,#1e88e5,#1565c0)}
        .city-sucre{background:linear-gradient(135deg,#5e35b1,#4527a0)}

            @media (max-width: 768px){.container{padding:0 6px}.table-card{padding:16px}.controls{width:100%;flex-wrap:wrap}.logo{font-size:2.6rem}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">SUMMER</div>
            <div class="subtitle">ðŸ“Š Dashboard de Ventas - AÃ±o Nuevo 2026</div>
        </header>

        <div class="stats">
            <div class="stat-card">
                <h3 id="totalSales">0</h3>
                <p>Total Ventas</p>
            </div>
            <div class="stat-card">
                <h3 id="totalTickets">0</h3>
                <p>Total Tickets</p>
            </div>
        </div>

        <div class="chips" id="cityChips"></div>

        <div class="table-card">
            <div class="table-header">
                <h2>ðŸ“‹ Registro Completo</h2>
                <div class="controls">
                    <select id="cityFilter">
                        <option value="">Todas las ciudades</option>
                    </select>
                    <input id="searchInput" type="search" placeholder="Buscar por LÃ­der o RRPP" />
                    <button class="btn" onclick="refresh()">ðŸ”„ Actualizar</button>
                    <button class="btn" onclick="exportCSV()">ï¿½ Exportar CSV</button>
                </div>
            </div>
            <div class="table-wrap">
            <table>
                <colgroup>
                    <col class="id" />
                    <col />
                    <col />
                    <col class="city" />
                    <col class="tickets" />
                    <col class="receipt" />
                    <col class="date" />
                </colgroup>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>LÃ­der</th>
                        <th>RRPP</th>
                        <th>Ciudad</th>
                        <th>Tickets</th>
                        <th>Comprobante</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody id="salesTable">
                    <tr><td colspan="7" style="text-align:center; padding:40px;">Cargando ventas...</td></tr>
                </tbody>
            </table>
            </div>
        </div>
    </div>

    <script>
        let allSales = [];
        let currentSales = [];

        async function loadData() {
            try {
                const [salesRes, statsRes] = await Promise.all([
                    fetch('/api/sales'),
                    fetch('/api/stats')
                ]);
                const sales = await salesRes.json();
                const stats = await statsRes.json();

                document.getElementById('totalSales').textContent = stats.totalSales || 0;
                document.getElementById('totalTickets').textContent = stats.totalTickets || 0;

                allSales = Array.isArray(sales) ? sales : [];
                renderChips(allSales);
                populateCityFilter(allSales);
                applyFilters();
            } catch (err) {
                console.error(err);
                document.getElementById('salesTable').innerHTML = '<tr><td colspan="7" class="error">Error al cargar datos</td></tr>';
            }
        }

        function applyFilters() {
            const city = document.getElementById('cityFilter').value.trim();
            const q = document.getElementById('searchInput').value.trim().toLowerCase();
            let filtered = allSales.slice();
            if (city) filtered = filtered.filter(s => (s.city || '').toLowerCase() === city.toLowerCase());
            if (q) filtered = filtered.filter(s => (s.team_leader||'').toLowerCase().includes(q) || (s.rrpp_name||'').toLowerCase().includes(q));
            currentSales = filtered;
            renderTable(filtered);
        }

        function cityKey(name){return (name||'General').toLowerCase().replace(/[^a-z]/g,'')}

        function renderTable(sales) {
            const tbody = document.getElementById('salesTable');
            if (!Array.isArray(sales) || sales.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty">No hay ventas registradas</td></tr>';
                    return;
                }

                tbody.innerHTML = sales.map(sale => `
                    <tr>
                        <td>${sale.id}</td>
                        <td>${escapeHtml(sale.team_leader)}</td>
                        <td>${escapeHtml(sale.rrpp_name)}</td>
                    <td><span class="pill pill-city city-${cityKey(sale.city)}">${escapeHtml(sale.city || 'General')}</span></td>
                    <td class="num"><span class="pill pill-count">${sale.ticket_quantity}</span></td>
                    <td>${sale.receipt_url ? `<a class="link" href="${sale.receipt_url}" target="_blank" rel="noopener">ðŸ“· Ver comprobante</a>` : '<span style="color:#888">Sin comprobante</span>'}</td>
                        <td>${new Date(sale.created_at).toLocaleString('es')}</td>
                    </tr>
                `).join('');
        }

        function exportCSV() {
            const sales = currentSales.length ? currentSales : allSales;
            let csv = 'ID,LÃ­der,RRPP,Ciudad,Tickets,ComprobanteURL,Fecha\n';
            sales.forEach(sale => {
                csv += `${sale.id},"${sale.team_leader}","${sale.rrpp_name}","${sale.city || ''}",${sale.ticket_quantity},"${sale.receipt_url || ''}","${new Date(sale.created_at).toLocaleString('es')}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ventas.csv';
            a.click();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text ?? '';
            return div.innerHTML;
        }

            function renderChips(sales) {
            const chips = document.getElementById('cityChips');
            const counts = sales.reduce((acc, s) => { const c = s.city || 'General'; acc[c] = (acc[c]||0)+s.ticket_quantity; return acc; }, {});
            const entries = Object.entries(counts).sort((a,b)=>a[0].localeCompare(b[0]));
                if (!entries.length) { chips.innerHTML = ''; return; }
                // AÃ±adimos separadores para que incluso sin estilos se vea legible
                chips.innerHTML = entries.map(([city, tickets]) => `<span class="chip">${city}: ${tickets} tickets</span>`).join(' <span style="opacity:.5;">â€¢</span> ');
        }

        function populateCityFilter(sales) {
            const select = document.getElementById('cityFilter');
            const cities = Array.from(new Set(sales.map(s => s.city || 'General'))).sort((a,b)=>a.localeCompare(b));
            select.innerHTML = '<option value="">Todas las ciudades</option>' + cities.map(c=>`<option value="${c}">${c}</option>`).join('');
        }

        function refresh() { loadData(); }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            document.getElementById('cityFilter').addEventListener('change', applyFilters);
            document.getElementById('searchInput').addEventListener('input', applyFilters);
        });
        setInterval(loadData, 30000);
    </script>
</body>
</html>
