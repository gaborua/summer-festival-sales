<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Summer Festival 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #E91E63 0%, #880E4F 50%, #4A148C 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        .logo {
            font-size: 3.5rem;
            font-weight: 900;
            letter-spacing: 3px;
            <!DOCTYPE html>
            <html lang="es">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>Dashboard - Summer Festival 2026</title>
              <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #E91E63 0%, #880E4F 50%, #4A148C 100%); min-height: 100vh; padding: 20px; }
                .container { max-width: 1400px; margin: 0 auto; }
                header { text-align: center; color: white; margin-bottom: 40px; }
                .logo { font-size: 3.5rem; font-weight: 900; letter-spacing: 3px; text-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-bottom: 5px; }
                .subtitle { font-size: 1.3rem; font-weight: 600; opacity: 0.95; }
                .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 35px; }
                .stat-card { background: white; padding: 35px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; transition: transform 0.3s; }
                .stat-card:hover { transform: translateY(-5px); }
                .stat-card h3 { font-size: 3.5rem; background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; font-weight: 900; }
                .stat-card p { color: #666; font-size: 1.2rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
                .table-card { background: white; padding: 35px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow-x: auto; }
                .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
                .table-header h2 { color: #E91E63; font-size: 1.8rem; font-weight: 700; }
                table { width: 100%; border-collapse: collapse; }
                th, td { padding: 16px; text-align: left; border-bottom: 2px solid #f5f5f5; }
                th { background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); color: white; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.9rem; }
                th:first-child { border-radius: 12px 0 0 0; }
                th:last-child { border-radius: 0 12px 0 0; }
                tr:hover { background: #fce4ec; }
                td { color: #333; font-size: 0.95rem; }
                button { padding: 14px 28px; background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 6px 20px rgba(233, 30, 99, 0.4); transition: all 0.3s; }
                button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(233, 30, 99, 0.5); }
                .empty, .error { text-align: center; padding: 40px; color: #555; }
              </style>
            </head>
            <body>
              <div class="container">
                <header>
                  <div class="logo">SUMMER</div>
                  <div class="subtitle">üìä Dashboard de Ventas - A√±o Nuevo 2026</div>
                </header>

                <div class="stats">
                  <div class="stat-card">
                    <h3 id="totalSales">0</h3>
                    <p>Total Ventas</p>
                  </div>
                  <div class="stat-card">
                    <h3 id="totalTickets">0</h3>
                    <p>Total Tickets</p>
                  </div>
                </div>

                <div class="table-card">
                  <div class="table-header">
                    <h2>üìã Registro Completo</h2>
                    <button onclick="exportCSV()">üìÅ Exportar CSV</button>
                  </div>
                  <table>
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>L√≠der</th>
                        <th>RRPP</th>
                        <th>Ciudad</th>
                        <th>Tickets</th>
                        <th>Comprobante</th>
                        <th>Fecha</th>
                      </tr>
                    </thead>
                    <tbody id="salesTable">
                      <tr><td colspan="7" style="text-align:center; padding:40px;">Cargando ventas...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <script>
                async function loadData() {
                  try {
                    const [salesRes, statsRes] = await Promise.all([
                      fetch('/api/sales'),
                      fetch('/api/stats')
                    ]);
                    const sales = await salesRes.json();
                    const stats = await statsRes.json();

                    document.getElementById('totalSales').textContent = stats.totalSales || 0;
                    document.getElementById('totalTickets').textContent = stats.totalTickets || 0;

                    const tbody = document.getElementById('salesTable');
                    if (!Array.isArray(sales) || sales.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="7" class="empty">No hay ventas registradas</td></tr>';
                      return;
                    }

                    tbody.innerHTML = sales.map(sale => `
                      <tr>
                        <td>${sale.id}</td>
                        <td>${escapeHtml(sale.team_leader)}</td>
                        <td>${escapeHtml(sale.rrpp_name)}</td>
                        <td>${escapeHtml(sale.city || '')}</td>
                        <td>${sale.ticket_quantity}</td>
                        <td>${sale.receipt_url ? `<a href="${sale.receipt_url}" target="_blank" rel="noopener">üì∑ Ver comprobante</a>` : '<span style="color:#888">Sin comprobante</span>'}</td>
                        <td>${new Date(sale.created_at).toLocaleString('es')}</td>
                      </tr>
                    `).join('');
                  } catch (err) {
                    console.error(err);
                    document.getElementById('salesTable').innerHTML = '<tr><td colspan="7" class="error">Error al cargar datos</td></tr>';
                  }
                }

                function exportCSV() {
                  fetch('/api/sales')
                    .then(res => res.json())
                    .then(sales => {
                      let csv = 'ID,L√≠der,RRPP,Ciudad,Tickets,ComprobanteURL,Fecha\n';
                      sales.forEach(sale => {
                        csv += `${sale.id},"${sale.team_leader}","${sale.rrpp_name}","${sale.city || ''}",${sale.ticket_quantity},"${sale.receipt_url || ''}","${new Date(sale.created_at).toLocaleString('es')}"\n`;
                      });
                      const blob = new Blob([csv], { type: 'text/csv' });
                      const url = window.URL.createObjectURL(blob);
                      const a = document.createElement('a');
                      a.href = url;
                      a.download = 'ventas.csv';
                      a.click();
                    });
                }

                function escapeHtml(text) {
                  const div = document.createElement('div');
                  div.textContent = text ?? '';
                  return div.innerHTML;
                }

                loadData();
                setInterval(loadData, 30000);
              </script>
            </body>
            </html>

